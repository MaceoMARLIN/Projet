<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Grab simplifié</title>
    <meta name="description" content="Test grab sans fakeBall" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.5.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@master/dist/aframe-physics-system.min.js"></script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8">

      <a-assets>
        <a-asset-item id="pin_model" src="bowling_pin.glb"></a-asset-item>
        <a-asset-item id="gutter_model" src="gut.glb"></a-asset-item>
      </a-assets>
      <!-- Sol -->
      <a-box 
        position="0 -0.025 -9"
        width="1.5"
        height="0.05"
        depth="18.5"
        color="#7BC8A4" 
        static-body>
      </a-box>

      <!-- Ciel -->
      <a-sky color="#ECECEC"></a-sky>

      <a-assets id="level3map">
        <!-- Quilles -->
        <a-entity gltf-model="#pin_model" position="0 0.5 -17" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="0.2 0.5 -17.2" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="-0.2 0.5 -17.2" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="0.4 0.5 -17.4" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="-0.4 0.5 -17.4" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="0 0.5 -17.4" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="0.6 0.5 -17.6" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="-0.6 0.5 -17.6" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="0.2 0.5 -17.6" dynamic-body="mass: 1"></a-entity>
        <a-entity gltf-model="#pin_model" position="-0.2 0.5 -17.6" dynamic-body="mass: 1"></a-entity>

        <!-- Gouttières -->
        <a-entity gltf-model="#gutter_model" position="1 -0.3 -7.9" scale="0.6 0.6 1.8" static-body></a-entity>
        <a-entity gltf-model="#gutter_model" position="-1 -0.3 -7.9" scale="0.6 0.6 1.8" static-body></a-entity>
      </a-assets>


      <!-- Joueur -->
      <a-entity id="rig" position="0 0 0" movement-controls="speed: 0.1">
        <!-- Caméra -->
        <a-entity camera look-controls position="0 1.6 0"></a-entity>

        <!-- Main gauche -->
        <a-entity 
          id="leftHand"
          static-body="shape: sphere; sphereRadius: 0.03"
          oculus-touch-controls="hand: left; model: true">
        </a-entity>

        <!-- Main droite (avec grab) -->
        <a-entity 
          id="rightHand"
          static-body="shape: sphere; sphereRadius: 0.03"
          oculus-touch-controls="hand: right; model: true"
          sphere-collider="objects: .grabbable"
          grabbygrip>
        </a-entity>

        <!-- Objet à attraper -->
        <a-sphere 
          id="ball" 
          class="grabbable" 
          radius="0.11" 
          color="red" 
          position="0 1.6 -0.5" 
          dynamic-body="shape: sphere; sphereRadius: 0.1; mass: 1">
      </a-sphere>
      </a-entity>

    </a-scene>

    <script>
      AFRAME.registerComponent('grabbygrip', {
        init: function (){
          this.system = this.el.sceneEl.systems.physics;
          this.GRABBED_STATE = 'grabbed';

          this.grabbing = false;
          this.hitEl = null;
          this.constraint = null; 

          this.onHit = this.onHit.bind(this);
          this.onGripOpen = this.onGripOpen.bind(this);
          this.onGripClose = this.onGripClose.bind(this);
        },

        play: function() {
          const el = this.el;
          el.addEventListener('hit', this.onHit);
          el.addEventListener('gripdown', this.onGripClose);
          el.addEventListener('gripup', this.onGripOpen);
        },

        pause: function() {
          const el = this.el;
          el.removeEventListener('hit', this.onHit);
          el.removeEventListener('gripdown', this.onGripClose);
          el.removeEventListener('gripup', this.onGripOpen);
        },

        onGripClose: function() {
          this.grabbing = true;
        },

        onGripOpen: function() {
          const hitEl = this.hitEl;
          this.grabbing = false;
          if (!hitEl) { return; }

          // On libère l’objet
          hitEl.removeState(this.GRABBED_STATE);
          this.hitEl = null;
          this.system.removeConstraint(this.constraint);
          this.constraint = null;
        },

        onHit: function (e) {
          const hitEl = e.detail.body ? e.detail.body.el : e.detail.el;

          // Conditions pour éviter bugs
          if (!this.grabbing || hitEl === this.el || hitEl.is(this.GRABBED_STATE)) { return; }

          this.hitEl = hitEl;
          hitEl.addState(this.GRABBED_STATE);

          // On attache l’objet avec une LockConstraint
          this.constraint = new CANNON.LockConstraint(this.el.body, hitEl.body);
          this.system.addConstraint(this.constraint);
        }
      });
      AFRAME.registerComponent('menu-controls', {
        init: function () {
          const el = this.el;

          el.querySelector('#level1').addEventListener('click', () => {
            console.log('Level 1 selected');
            loadLevel(1);
          });

          el.querySelector('#level2').addEventListener('click', () => {
            console.log('Level 2 selected');
            loadLevel(2);
          });
        }
      });

  function loadLevel(level) {
    // Exemple simple : changer la couleur du sol ou charger une autre scène
    const scene = document.querySelector('a-scene');
    if (level === 1) {
      scene.querySelector('a-plane').setAttribute('color', '#7BC8A4');
    } else {
      scene.querySelector('a-plane').setAttribute('color', '#FF7043');
    }
  }
    </script>
  </body>
</html>